# Bot Office - Telegram Bot для управления офисными процессами

## 🎯 Описание проекта

**Bot Office** - это многофункциональный Telegram бот для автоматизации офисных процессов и управления корпоративными задачами. Бот предоставляет удобный интерфейс для поиска сотрудников, управления новостями, планирования графиков дежурств и кофемашины, а также веб-интерфейс для модераторов.

### 🌟 Основные возможности
- 👥 **Поиск сотрудников** - быстрый поиск по базе контактов
- 📰 **Управление новостями** - создание, редактирование и публикация корпоративных новостей
- 📅 **Графики дежурств** - планирование и управление дежурствами
- ☕ **Кофемашина** - система управления кофемашиной и графиком кофе
- 🛡️ **Система ролей** - администратор, модератор, маркетолог
- 🌐 **Веб-интерфейс** - удобный веб-интерфейс для модераторов
- 📊 **Статистика** - аналитика и отчеты

## 🚀 Быстрый старт

### Предварительные требования
- Python 3.8 или выше
- Telegram Bot Token (получить у [@BotFather](https://t.me/BotFather))
- Доступ к базе данных SQLite

### Установка

1. **Клонируйте репозиторий**
```bash
git clone https://github.com/ermolaev-bst/Bots.git
cd Bots/bot_office
```

2. **Установите зависимости**
```bash
pip install -r requirements.txt
```

3. **Настройте переменные окружения**
Создайте файл `.env` в корне проекта:
```env
# Основные настройки бота
BOT_TOKEN=your_telegram_bot_token_here
ADMIN_ID=your_admin_telegram_id

# Настройки канала
CHANNEL_CHAT_ID=@your_channel_username
INVITE_LINK=https://t.me/+your_invite_link

# Пути к файлам
EXCEL_FILE_PATH=./contacts_example.xlsx

# Настройки базы данных
DATABASE_PATH=./bot.db

# Настройки логирования
LOG_LEVEL=INFO
LOG_FILE=./bot.log
```

4. **Подготовьте Excel файлы**
- Скопируйте `contacts_example.xlsx` и заполните данными сотрудников
- Скопируйте `channel_users_example.xlsx` для синхронизации с каналом

5. **Запустите бота**
```bash
python bot.py
```

## 👥 Система ролей и функций

### 👑 Администратор
**Полный доступ ко всем функциям системы**

#### Управление пользователями
- 📋 Просмотр заявок на авторизацию
- 👥 Управление пользователями (добавление, редактирование, удаление)
- 👑 Назначение и изменение ролей
- ❌ Удаление пользователей из системы
- 🔍 Просмотр статистики пользователей

#### Системные функции
- 🔔 Отправка уведомлений всем пользователям
- 🔄 Синхронизация данных с Excel файлами
- 📺 Синхронизация пользователей канала
- 🔗 Управление пригласительными ссылками
- ⚙️ Настройка системных параметров

#### Аналитика
- 📊 Просмотр статистики использования бота
- 📈 Анализ активности пользователей
- 📋 Отчеты по функциям

### 🛡️ Модератор
**Доступ к основным функциям управления**

#### Поиск и информация
- 🔍 Поиск сотрудников по имени, должности, отделу
- 📞 Просмотр контактной информации
- 📷 Просмотр фотографий сотрудников

#### Управление графиками
- 📅 Просмотр графика дежурств на месяц
- 📅 Управление графиком кофемашины
- 📝 Создание и редактирование графиков

#### Новости
- 📝 Предложение новостей для публикации
- 📋 Просмотр предложенных новостей
- ✏️ Редактирование предложенных новостей

#### Уведомления
- 🔔 Отправка уведомлений пользователям
- 📢 Массовые рассылки

### 📢 Маркетолог
**Специализированные функции для маркетинга**

#### Управление новостями
- 📝 Создание новых новостей
- ✏️ Редактирование существующих новостей
- 📢 Публикация новостей в канал
- 📋 Просмотр предложений новостей от модераторов
- 🗑️ Удаление новостей

#### Планирование
- 📅 Планировщик публикаций
- ⏰ Настройка времени публикации
- 📊 Планирование контент-календаря

#### Аналитика
- 📈 Статистика публикаций
- 📊 Анализ эффективности контента
- 📋 Отчеты по активности канала

## 📁 Структура проекта

Проект использует **модульную архитектуру** для лучшей организации кода:

```
bot_office/
├── 📄 bot.py                    # Главный файл запуска (167 строк)
├── 📄 config.py                 # Конфигурация и переменные окружения
├── 📄 database.py               # Работа с базой данных
├── 📁 handlers/                 # 🎯 Обработчики событий бота
│   ├── 📄 __init__.py
│   ├── 📄 common_handlers.py    # Общие команды (/start, /help)
│   ├── 📄 user_handlers.py      # Пользовательские функции
│   ├── 📄 admin_handlers.py     # Административные функции
│   └── 📄 moderator_handlers.py # Функции модератора и маркетолога
├── 📁 keyboards/                # ⌨️ Интерфейсы и клавиатуры
│   ├── 📄 __init__.py
│   └── 📄 inline_keyboards.py
├── 📁 services/                 # 🔧 Бизнес-логика
│   ├── 📄 __init__.py
│   ├── 📄 excel_service.py      # Работа с Excel файлами
│   ├── 📄 notification_service.py # Уведомления
│   └── 📄 sync_service.py       # Синхронизация данных
├── 📁 states/                   # 🔄 FSM состояния
│   ├── 📄 __init__.py
│   ├── 📄 user_states.py
│   ├── 📄 admin_states.py
│   └── 📄 moderator_states.py
├── 📁 utils/                    # 🛠️ Вспомогательные функции
│   ├── 📄 __init__.py
│   ├── 📄 helpers.py            # Общие утилиты
│   └── 📄 decorators.py         # Декораторы доступа
├── 📄 requirements.txt          # Зависимости Python
├── 📄 README.md                 # Документация (этот файл)
├── 📄 CHANGELOG.md              # История изменений
├── 📄 REFACTORING_GUIDE.md      # Руководство по модульной архитектуре
├── 📄 .gitignore                # Исключения Git
├── 📊 contacts_example.xlsx     # Пример структуры контактов
├── 📄 bot.db                    # База данных SQLite
└── 📄 bot.log                   # Лог файл
```

### 🏗️ Преимущества модульной архитектуры:

- **📖 Читаемость**: Код разделен по логическим модулям
- **📈 Масштабируемость**: Легко добавлять новые функции
- **🛠️ Поддержка**: Простое исправление ошибок и обновления
- **🧪 Тестируемость**: Модули можно тестировать независимо
- **♻️ Переиспользование**: Общие компоненты в отдельных сервисах
- **⚡ Производительность**: Оптимизированная загрузка модулей

### 📊 Сравнение с предыдущей версией:
- **Старый bot.py**: 3511 строк кода
- **Новый bot.py**: 167 строк кода  
- **Сокращение**: 95% кода вынесено в модули
- **Новых файлов**: 15 модулей для организации кода

## 🔧 Технические детали

### Архитектура
- **Backend**: Python 3.8+ с aiogram 3.x
- **База данных**: SQLite с aiosqlite
- **Веб-интерфейс**: Flask с HTML/CSS
- **Обработка данных**: pandas, openpyxl
- **Логирование**: Встроенное логирование Python

### Основные компоненты

#### bot.py
Главный файл бота, содержащий:
- Инициализацию бота и диспетчера
- Регистрацию обработчиков
- Основную логику работы

#### database.py
Модуль для работы с базой данных:
- Создание и управление таблицами
- CRUD операции для пользователей
- Управление ролями и правами

#### inline_keyboards.py
Клавиатуры и меню:
- Инлайн клавиатуры для навигации
- Reply клавиатуры для быстрого доступа
- Динамические меню

#### moderator_web.py
Веб-интерфейс для модераторов:
- Flask приложение
- HTML шаблоны
- API для управления данными

## 📊 Структура данных

### Таблицы базы данных

#### users
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    telegram_id INTEGER UNIQUE,
    username TEXT,
    first_name TEXT,
    last_name TEXT,
    role TEXT DEFAULT 'user',
    is_authorized BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### news
```sql
CREATE TABLE news (
    id INTEGER PRIMARY KEY,
    title TEXT,
    content TEXT,
    author_id INTEGER,
    status TEXT DEFAULT 'draft',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    published_at TIMESTAMP
);
```

#### schedules
```sql
CREATE TABLE schedules (
    id INTEGER PRIMARY KEY,
    type TEXT, -- 'duty' или 'coffee'
    user_id INTEGER,
    date DATE,
    time TIME,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Excel файлы

#### contacts_example.xlsx
Структура для импорта контактов:
- ФИО
- Должность
- Отдел
- Номер Телефона
- Короткий Номер
- e-mail
- Фото

#### channel_users_example.xlsx
Структура для синхронизации с каналом:
- Telegram ID
- Username
- First Name
- Last Name
- Role

## 🚀 Развертывание

### Локальное развертывание
```bash
# Клонирование
git clone https://github.com/ermolaev-bst/Bots.git
cd Bots/bot_office

# Установка зависимостей
pip install -r requirements.txt

# Настройка
cp env_example.txt .env
# Отредактируйте .env файл

# Запуск
python bot.py
```

### Развертывание на сервере
```bash
# Использование готового скрипта
chmod +x deploy.sh
./deploy.sh

# Или ручное развертывание
sudo cp corporate-bot.service /etc/systemd/system/
sudo systemctl enable corporate-bot
sudo systemctl start corporate-bot
```

### Docker развертывание
```dockerfile
FROM python:3.9-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .
CMD ["python", "bot.py"]
```

## 🧪 Тестирование

### Тест основных функций
```bash
python bot.py
```

### Тест миграции
```bash
python migrate_roles.py
```

### Тест синхронизации
```bash
python run_sync_employees.py
```

## 📝 API документация

### Веб-интерфейс API

#### GET /admin/users
Получение списка пользователей
```json
{
  "users": [
    {
      "id": 1,
      "telegram_id": 123456789,
      "username": "user123",
      "first_name": "Иван",
      "last_name": "Иванов",
      "role": "moderator",
      "is_authorized": true
    }
  ]
}
```

#### POST /admin/users
Создание нового пользователя
```json
{
  "telegram_id": 123456789,
  "username": "newuser",
  "first_name": "Новый",
  "last_name": "Пользователь",
  "role": "user"
}
```

#### PUT /admin/users/{id}
Обновление пользователя
```json
{
  "role": "moderator",
  "is_authorized": true
}
```

## 🔒 Безопасность

### Аутентификация
- Проверка Telegram ID для доступа к функциям
- Система ролей с разграничением прав
- Авторизация через администратора

### Валидация данных
- Проверка входных данных
- Санитизация пользовательского ввода
- Защита от SQL-инъекций

### Логирование
- Логирование всех действий пользователей
- Отслеживание ошибок и исключений
- Ротация лог файлов

## 🐛 Устранение неполадок

### Частые проблемы

#### Бот не отвечает
1. Проверьте токен бота в `.env`
2. Убедитесь, что бот запущен
3. Проверьте логи в `bot.log`

#### Ошибки базы данных
1. Проверьте права доступа к `bot.db`
2. Убедитесь в корректности SQL запросов
3. Проверьте структуру таблиц

#### Проблемы с Excel файлами
1. Проверьте путь к файлу в `.env`
2. Убедитесь в корректности структуры
3. Проверьте права доступа к файлам

### Логи и отладка
```bash
# Просмотр логов
tail -f bot.log

# Проверка статуса сервиса
sudo systemctl status corporate-bot

# Тест подключения к базе данных
python -c "import sqlite3; sqlite3.connect('bot.db')"
```

## 📈 Мониторинг и аналитика

### Метрики для отслеживания
- Количество активных пользователей
- Популярность функций
- Время отклика бота
- Ошибки и исключения

### Интеграция с системами мониторинга
- Prometheus метрики
- Grafana дашборды
- Sentry для отслеживания ошибок

## 🤝 Вклад в проект

### Как внести вклад
1. Форкните репозиторий
2. Создайте ветку для новой функции
3. Внесите изменения
4. Создайте Pull Request

### Стандарты кода
- PEP 8 для Python кода
- Документирование функций
- Тестирование новых функций
- Обновление документации

## 📄 Лицензия

Этот проект распространяется под лицензией MIT. См. файл [LICENSE](LICENSE) для подробностей.

## 📞 Поддержка

При возникновении проблем:
1. Проверьте настройки в .env файле
2. Убедитесь в правильности токена бота
3. Проверьте права доступа к базе данных
4. Создайте Issue в репозитории для получения помощи

---

**Bot Office v1.0.0** - Управление офисными процессами стало проще! 🚀 